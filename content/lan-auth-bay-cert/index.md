---
title: 証明書によるLAN認証は育成基盤
author: 田中(゜p゜)
type: page
date: 2020-09-05T07:12:32+00:00
catchbox-sidebarlayout:
  - default
og_img:
  - /wp-content/uploads/2020/09/image-17.png

---
**いきなりワケの分からないタイトル**で恐縮ですが、田中(゜p゜)はこの領域に手を伸ばしたことで、ネットワークエンジニアから大きく枠外に飛び出して行ったという経緯あり、個人的にもインパクトのあった仕組みだったので、記事化してみました。

## 証明書によるLAN認証とは？

簡単に言うと、**「LAN」に接続させる際にコンピュータとかユーザ固有のデバイス証明書を確認する**仕組みで、設定項目として**EAP-TLS**とかそんな名前で出てきます。たぶんネットワーク視点だと<a href="https://www.infraexpert.com/study/wireless14.html" target="_blank" rel="noreferrer noopener">こっちのページ(外部サイト)</a>のほうが詳しい。  
  
Radiusサーバなんかが必要となるので、個人だったり、小規模の企業だと導入していないところもあると思いますが、**LANのセキュリティとしては最強**だと田中(゜p゜)は考えとります。  
  
また、Radiusサーバー側で、認証されたユーザ、されてないユーザのVLANの指定ができるので、検疫システムにも使われてたりする。  
  
つまり、認証されてないユーザは、検疫LANに振り分けて、検疫LANの中にある検液用のアプライアンスがPCをチェックした上で、本番LANに接続させる仕組み。  
  
あとポイントは、この技術は無線LANで発達したものだけど、**有線LANでも使える**ということ。有線LAN側でキッチリ認証しておけば、MACアドレスで同セグメント内の端末をはじいたりするような、費用対効果の低い仕組みを入れる必要がない。

## デメリット

**証明書というのは往々にして運用が面倒**です。  
そもそも証明機関サーバーが必要だし、その証明機関から発行した証明書を、PC一台一台に入れてかないとだし、その後の運用もしんどい。  
  
**往々にして「セキュリティ」と「コスト」と「利便性」は共存できない**ものなのです。

## 解決策

実はこの**証明書運用問題をスッキリ解決する方法**があります。  
田中(゜p゜)はネットワークエンジニアだったのですが、なんとかしてこの証明書の配布による運用コストを低減すべく試行錯誤した結果、**運用工数を大きく削減できる仕組み**にたどり着きました。  
  
というか、我々は既にPCの管理を簡易化でき、設定やセキュリティポリシーを配布できる素晴らしい仕組みを持っていたのです。  
  
つ [ActiveDirectory][1]。  
※できればドラえもんの道具調で言いたい。ひみつ道具なので。

## WindowsによるEAP-TLS基盤構築

証明書によるLAN認証にとっての課題は、証明書の運用負荷ですが、実はWindowsセットでそれを全て揃えてしまうことにより、**ほぼ自動化**できます。  
  
使うコンポーネントは以下です。

  * Active Directory
  * ドメイン参加してるWindows CA(証明書発行機関)
  * ドメイン参加してるWindows NPS(Radiusサーバ)

仕組みとしては概ね以下です。※なんかカラフルになってしまって恥ずかしい…。

<div class="wp-block-image">
  <figure class="aligncenter size-large"><img src="/wp-content/uploads/2020/09/image-17.png" alt="" /></figure>
</div>

  * ①ADのポリシーで、PCとRadiusサーバに対して証明書取得指示を出す
  * ②PC・Radiusサーバが証明書を取得する。
  * ③PCとRadiusサーバーは、発行された証明書を付きあわせて認証する。

あと、PCにEAP-TLS設定を入れていく必要ありますが、これも①の段階でポリシーで配布してしまえば良いです。

**そう、ADならね。**

とか言いたくなっちゃう。  
田中(゜p゜)は、この仕組みを使って、**無線LAN系の提案のコンペで無敗**を誇りました。競合他社がNetAttestを出してきた時はニヤニヤしてましたね。ま、10年以上前のことですけど。  
  
それと、この仕組みは有線LANでも使えるので、LANセグメントに無駄なセキュリティ機器とか入れる必要なくなります。  
  
他、細かい話でコンピュータ証明書とユーザ証明書の違いで接続タイミングが変わったりするとか、プリンタとか802.1xに対応してない機器どーすんだ、みたいな話あるのですが、まあそれは割愛。  
  
細かい話聞きたい方は、[フォーラム][2]でトピック立てて質問して下さい。

## ユーザから見るとどうなるか

ドメインに入ってない端末は、仮のVLANに割り当てられて、ADととしか通信できず、そこでドメインに入り、証明機関から証明書を取得します。このあたりは、情報システム部門で端末をセットアップする際にドメインに入ってユーザに渡す等、運用を変えてもいいと思います。

<div class="wp-block-image">
  <figure class="aligncenter size-large is-resized"><img loading="lazy" src="/wp-content/uploads/2020/09/image-24.png" alt="" width="365" height="295" /></figure>
</div>

  
一度ドメインに入った端末は、本番VLANの有線LANに接続できるようになります。  
ユーザから見ると、証明書は一切関わってこないように見えます。  
  
これで**ほぼシームレスに証明書を配布することができました。**

## 育成基盤としての802.1x

余談ですが、この仕組みは、**自分で検証基盤を作ってみることをオススメ**します。先に書いたように田中(゜p゜)は、この仕組みを学ぶことで、他領域に対しての学習が深まりました。  
  
なぜって、**AD、Windowsサーバ、PCの知識がいっぺんに必要**で、ユーザが利用に至るまでの流れが理解できるから。ADによるドメイン構築や、ポリシー配布の基礎が学べるし。**サーバーエンジニアはネットワークの基本知識が学べる**し。  
  
個人でやるとしたら、スイッチはヤフオク、メルカリ等で、802.1x対応のものを購入するとして、サーバーはOSの調達が難しいので、クラウドで立てるのがいい気がします。

ちょっと以下の赤字ような工夫必要かもだけど。  
自力のある人は、ルータをVPN対応に置き換えて、クラウドとVPN貼ってもいいかもしれない。

<div class="wp-block-image">
  <figure class="aligncenter size-large"><img src="/wp-content/uploads/2020/09/image-23.png" alt="" /></figure>
</div>

すいません。これやった時に利用したサイト紹介したかったんですが、今なくなってるんで、<a href="https://www.alaxala.com/jp/techinfo/archive/guide/pdf/N14R030_RADIUS_Win2012_V1_R0.pdf" target="_blank" rel="noreferrer noopener">このあたり</a>をオススメしておきます。

## まとめ

  * 802.1xは、証明書を使って端末をLAN認証する
  * 証明書の運用は運用負荷が高いが、ADによって軽減できる
  * 自分で検証環境をつくると、技術領域の幅が広がる。

って、さんざんクラウド関係でLANなんて無い方がいい的なこと言っといて、思い切りLAN技術の話してますね。ま、いきなりなくなってしまうことはないので、ご参考に、ということで。

 [1]: /article/how-delicious-ad-is/
 [2]: /forums/forum/infrastructure/